---
# One-time bootstrap for a fresh Ubuntu server.
# Creates the 'pops' service user, deploys SSH key, grants sudo.
#
# Usage:
#   ansible-playbook ansible/playbooks/bootstrap.yml \
#     -u joao --ask-pass --ask-become-pass
#
# After this runs successfully, all other playbooks connect as 'pops' via SSH key.

- name: Bootstrap POPS server
  hosts: pops_servers
  become: true
  gather_facts: false

  tasks:
    - name: Wait for SSH to become available
      ansible.builtin.wait_for_connection:
        timeout: 30

    - name: Gather facts
      ansible.builtin.setup:

    - name: Create pops service user
      ansible.builtin.user:
        name: "{{ pops_user }}"
        shell: /bin/bash
        groups: sudo
        append: true
        create_home: true

    - name: Deploy SSH public key for pops
      ansible.posix.authorized_key:
        user: "{{ pops_user }}"
        key: "{{ lookup('file', '~/.ssh/pops_n95.pub') }}"
        state: present

    - name: Allow pops passwordless sudo
      ansible.builtin.copy:
        content: "{{ pops_user }} ALL=(ALL) NOPASSWD:ALL\n"
        dest: "/etc/sudoers.d/{{ pops_user }}"
        owner: root
        group: root
        mode: "0440"
        validate: /usr/sbin/visudo -cf %s

    - name: Verify SSH key login works
      ansible.builtin.command:
        cmd: "ssh -i ~/.ssh/pops_n95 -o StrictHostKeyChecking=no -o BatchMode=yes {{ pops_user }}@{{ ansible_host }} whoami"
      delegate_to: localhost
      become: false
      changed_when: false
      register: ssh_test

    - name: Report bootstrap result
      ansible.builtin.debug:
        msg: "Bootstrap complete. SSH key login as '{{ pops_user }}' verified: {{ ssh_test.stdout }}"
