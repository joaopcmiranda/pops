# Production docker-compose.yml â€” templated by Ansible
# Paths reference /opt/pops/secrets/ written by the secrets role.

services:
  notion-sync:
    build:
      context: {{ docker_compose_dir }}/repo
      dockerfile: services/notion-sync/Dockerfile
    container_name: pops-notion-sync
    restart: "no"
    networks:
      - backend
    volumes:
      - sqlite-data:/data/sqlite
    secrets:
      - notion_api_token
    environment:
      NODE_ENV: production
      SQLITE_PATH: /data/sqlite/pops.db
      NOTION_TOKEN_FILE: /run/secrets/notion_api_token

  finance-api:
    build:
      context: {{ docker_compose_dir }}/repo
      dockerfile: services/finance-api/Dockerfile
    container_name: pops-finance-api
    restart: unless-stopped
    networks:
      - frontend
      - backend
    volumes:
      - sqlite-data:/data/sqlite:ro
    secrets:
      - notion_api_token
      - up_bank_token
      - up_webhook_secret
      - finance_api_key
      - claude_api_key
    environment:
      NODE_ENV: production
      SQLITE_PATH: /data/sqlite/pops.db
      PORT: "3000"
    expose:
      - "3000"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r=>{if(!r.ok)process.exit(1)})"]
      interval: 30s
      timeout: 5s
      retries: 3

  pops-pwa:
    build:
      context: {{ docker_compose_dir }}/repo
      dockerfile: services/pops-pwa/Dockerfile
    container_name: pops-pwa
    restart: unless-stopped
    networks:
      - frontend
    expose:
      - "80"

  metabase:
    image: metabase/metabase:{{ metabase_version }}
    container_name: pops-metabase
    restart: unless-stopped
    networks:
      - frontend
    volumes:
      - metabase-data:/metabase-data
      - sqlite-data:/data/sqlite:ro
    environment:
      MB_DB_FILE: /metabase-data/metabase.db
      MB_JETTY_PORT: "3000"
      JAVA_TOOL_OPTIONS: -Xmx512m
    expose:
      - "3000"

  paperless-ngx:
    image: ghcr.io/paperless-ngx/paperless-ngx:{{ paperless_version }}
    container_name: pops-paperless
    restart: unless-stopped
    networks:
      - documents
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-consume:/usr/src/paperless/consume
    secrets:
      - paperless_secret_key
      - paperless_admin_password
    environment:
      PAPERLESS_SECRET_KEY_FILE: /run/secrets/paperless_secret_key
      PAPERLESS_REDIS: redis://paperless-redis:6379
      PAPERLESS_URL: https://{{ cf_subdomain_paperless }}.{{ domain }}
      PAPERLESS_TIME_ZONE: "{{ timezone }}"
      PAPERLESS_OCR_LANGUAGE: eng
      PAPERLESS_ADMIN_USER: admin
      PAPERLESS_ADMIN_PASSWORD_FILE: /run/secrets/paperless_admin_password
    expose:
      - "8000"
    depends_on:
      - paperless-redis

  paperless-redis:
    image: redis:{{ redis_version }}
    container_name: pops-paperless-redis
    restart: unless-stopped
    networks:
      - documents
    volumes:
      - paperless-redis:/data

  moltbot:
    image: moltbot/moltbot:latest
    container_name: pops-moltbot
    restart: unless-stopped
    networks:
      - backend
    volumes:
      - {{ docker_compose_dir }}/repo/services/moltbot/config/config.yml:/home/node/.moltbot/config.yml:ro
      - {{ docker_compose_dir }}/repo/services/moltbot/skills:/home/node/.moltbot/workspace/skills:ro
    secrets:
      - telegram_bot_token
      - claude_api_key
      - finance_api_key
    environment:
      TELEGRAM_BOT_TOKEN_FILE: /run/secrets/telegram_bot_token
      FINANCE_API_URL: http://finance-api:3000
      FINANCE_API_KEY_FILE: /run/secrets/finance_api_key

  cloudflared:
    image: cloudflare/cloudflared:{{ cloudflared_version }}
    container_name: pops-cloudflared
    restart: unless-stopped
    networks:
      - frontend
      - documents
    command: tunnel --no-autoupdate run --token {{ vault_cloudflare_tunnel_token }}
    environment:
      NO_AUTOUPDATE: "true"

networks:
  frontend:
    name: pops-frontend
    driver: bridge
  backend:
    name: pops-backend
    driver: bridge
  documents:
    name: pops-documents
    driver: bridge

volumes:
  sqlite-data:
    name: pops-sqlite-data
  metabase-data:
    name: pops-metabase-data
  paperless-data:
    name: pops-paperless-data
  paperless-media:
    name: pops-paperless-media
  paperless-consume:
    name: pops-paperless-consume
  paperless-redis:
    name: pops-paperless-redis

secrets:
  notion_api_token:
    file: {{ secrets_dir }}/notion_api_token
  up_bank_token:
    file: {{ secrets_dir }}/up_bank_token
  up_webhook_secret:
    file: {{ secrets_dir }}/up_webhook_secret
  claude_api_key:
    file: {{ secrets_dir }}/claude_api_key
  telegram_bot_token:
    file: {{ secrets_dir }}/telegram_bot_token
  finance_api_key:
    file: {{ secrets_dir }}/finance_api_key
  paperless_secret_key:
    file: {{ secrets_dir }}/paperless_secret_key
  paperless_admin_password:
    file: {{ secrets_dir }}/paperless_admin_password
