---
# Basic health check script â€” runs via systemd timer.
# Replace with Uptime Kuma when ready (Phase 2+).

- name: Create health check script
  ansible.builtin.copy:
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      SERVICES=("pops-finance-api" "pops-pwa" "pops-metabase" "pops-paperless" "pops-cloudflared" "pops-moltbot")
      FAILED=()

      for svc in "${SERVICES[@]}"; do
        if ! docker inspect --format='{{ '{{' }}.State.Running{{ '}}' }}' "$svc" 2>/dev/null | grep -q true; then
          FAILED+=("$svc")
        fi
      done

      if [ ${#FAILED[@]} -gt 0 ]; then
        echo "UNHEALTHY: ${FAILED[*]}" >&2
        exit 1
      fi

      echo "All services healthy."
    dest: /opt/pops/healthcheck.sh
    owner: root
    group: root
    mode: "0700"
  when: monitoring_enabled

- name: Create health check systemd service
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=POPS Health Check
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      ExecStart=/opt/pops/healthcheck.sh
    dest: /etc/systemd/system/pops-healthcheck.service
    owner: root
    group: root
    mode: "0644"
  when: monitoring_enabled

- name: Create health check timer (every 5 minutes)
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Run POPS health check every 5 minutes

      [Timer]
      OnCalendar=*:0/5
      Persistent=true

      [Install]
      WantedBy=timers.target
    dest: /etc/systemd/system/pops-healthcheck.timer
    owner: root
    group: root
    mode: "0644"
  when: monitoring_enabled

- name: Enable health check timer
  ansible.builtin.systemd:
    name: pops-healthcheck.timer
    state: started
    enabled: true
    daemon_reload: true
  when: monitoring_enabled
