---
- name: Install rclone
  ansible.builtin.apt:
    name: rclone
    state: present

- name: Install age encryption tool
  ansible.builtin.apt:
    name: age
    state: present

- name: Create backup directory
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Create backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: /opt/pops/backup.sh
    owner: root
    group: root
    mode: "0700"

- name: Create backup systemd service
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=POPS Backup to B2
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      ExecStart=/opt/pops/backup.sh
      TimeoutStartSec=1800
    dest: /etc/systemd/system/pops-backup.service
    owner: root
    group: root
    mode: "0644"

- name: Create backup systemd timer
  ansible.builtin.template:
    src: backup.timer.j2
    dest: /etc/systemd/system/pops-backup.timer
    owner: root
    group: root
    mode: "0644"

- name: Enable and start backup timer
  ansible.builtin.systemd:
    name: pops-backup.timer
    state: started
    enabled: true
    daemon_reload: true
