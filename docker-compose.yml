version: '3.8'

services:
  # PostgreSQL Database for Development
  postgres-dev:
    image: postgres:16-alpine
    container_name: pops-postgres-dev
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: pops_development
      POSTGRES_USER: pops_user
      POSTGRES_PASSWORD: pops_password
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./scripts/init-schemas.sql:/docker-entrypoint-initdb.d/init-schemas.sql
    networks:
      - pops-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pops_user -d pops_development"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - default

  # PostgreSQL Database for Testing
  postgres-test:
    image: postgres:16-alpine
    container_name: pops-postgres-test
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: pops_test
      POSTGRES_USER: pops_test_user
      POSTGRES_PASSWORD: pops_test_password
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./scripts/init-schemas.sql:/docker-entrypoint-initdb.d/init-schemas.sql
    networks:
      - pops-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pops_test_user -d pops_test"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - test
      - dev

  # Database Administration Interface
  adminer:
    image: adminer
    container_name: pops-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres-dev
    depends_on:
      - postgres-dev
    networks:
      - pops-network
    profiles:
      - dev

  # Frontend Travel App
  travel:
    build:
      context: .
      dockerfile: apps/travel/Dockerfile
    container_name: pops-travel
    ports:
      - "${WEB_PORT:-5173}:5173"
    environment:
      - VITE_TRIP_SERVICE_URL=http://localhost:8030
      - VITE_USER_SERVICE_URL=http://localhost:8011
      - VITE_ITINERARY_SERVICE_URL=http://localhost:8031
    networks:
      - pops-network
    profiles:
      - production

volumes:
  postgres_dev_data:
    driver: local
  postgres_test_data:
    driver: local

networks:
  pops-network:
    driver: bridge