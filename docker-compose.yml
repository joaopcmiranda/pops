services:
  # ── BACKEND ──────────────────────────────────────────────────────
  notion-sync:
    build: ./services/notion-sync
    container_name: pops-notion-sync
    restart: "no"
    networks:
      - backend
    volumes:
      - sqlite-data:/data/sqlite
    secrets:
      - notion_api_token
    environment:
      NODE_ENV: production
      SQLITE_PATH: /data/sqlite/pops.db
      NOTION_TOKEN_FILE: /run/secrets/notion_api_token

  finance-api:
    build: ./services/finance-api
    container_name: pops-finance-api
    restart: unless-stopped
    networks:
      - frontend
      - backend
    volumes:
      - sqlite-data:/data/sqlite:ro
    secrets:
      - notion_api_token
      - up_bank_token
      - up_webhook_secret
      - finance_api_key
      - claude_api_key
    environment:
      NODE_ENV: production
      SQLITE_PATH: /data/sqlite/pops.db
      PORT: "3000"
    expose:
      - "3000"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r=>{if(!r.ok)process.exit(1)})"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ── FRONTEND ─────────────────────────────────────────────────────
  pops-pwa:
    build: ./services/pops-pwa
    container_name: pops-pwa
    restart: unless-stopped
    networks:
      - frontend
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3

  metabase:
    image: metabase/metabase:v0.52.5
    container_name: pops-metabase
    restart: unless-stopped
    networks:
      - frontend
    volumes:
      - metabase-data:/metabase-data
      - sqlite-data:/data/sqlite:ro
    environment:
      MB_DB_FILE: /metabase-data/metabase.db
      MB_JETTY_PORT: "3000"
      JAVA_TOOL_OPTIONS: -Xmx512m
    expose:
      - "3000"

  # ── DOCUMENTS ────────────────────────────────────────────────────
  paperless-ngx:
    image: ghcr.io/paperless-ngx/paperless-ngx:2.14
    container_name: pops-paperless
    restart: unless-stopped
    networks:
      - documents
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-media:/usr/src/paperless/media
      - paperless-consume:/usr/src/paperless/consume
    secrets:
      - paperless_secret_key
      - paperless_admin_password
    environment:
      PAPERLESS_SECRET_KEY_FILE: /run/secrets/paperless_secret_key
      PAPERLESS_URL: https://paperless.pops.example.com
      PAPERLESS_TIME_ZONE: Australia/Melbourne
      PAPERLESS_OCR_LANGUAGE: eng
      PAPERLESS_ADMIN_USER: admin
      PAPERLESS_ADMIN_PASSWORD_FILE: /run/secrets/paperless_admin_password
    expose:
      - "8000"
    depends_on:
      - paperless-redis

  paperless-redis:
    image: redis:7-alpine
    container_name: pops-paperless-redis
    restart: unless-stopped
    networks:
      - documents
    volumes:
      - paperless-redis:/data

  # ── MOLTBOT ──────────────────────────────────────────────────────
  moltbot:
    image: moltbot/moltbot:latest
    container_name: pops-moltbot
    restart: unless-stopped
    networks:
      - backend
    volumes:
      - ./services/moltbot/config/config.yml:/home/node/.moltbot/config.yml:ro
      - ./services/moltbot/skills:/home/node/.moltbot/workspace/skills:ro
    secrets:
      - telegram_bot_token
      - claude_api_key
      - finance_api_key
    environment:
      TELEGRAM_BOT_TOKEN_FILE: /run/secrets/telegram_bot_token
      FINANCE_API_URL: http://finance-api:3000
      FINANCE_API_KEY_FILE: /run/secrets/finance_api_key

  # ── CLOUDFLARE TUNNEL ────────────────────────────────────────────
  cloudflared:
    image: cloudflare/cloudflared:2025.2.0
    container_name: pops-cloudflared
    restart: unless-stopped
    networks:
      - frontend
      - documents
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}

  # ── TOOLS (on-demand) ───────────────────────────────────────────
  tools:
    build: ./tools
    container_name: pops-tools
    profiles:
      - tools
    networks:
      - backend
    volumes:
      - sqlite-data:/data/sqlite
      - ./tools/data:/data/imports
    secrets:
      - notion_api_token
      - claude_api_key
      - up_bank_token
    environment:
      SQLITE_PATH: /data/sqlite/pops.db

networks:
  frontend:
    name: pops-frontend
    driver: bridge
  backend:
    name: pops-backend
    driver: bridge
  documents:
    name: pops-documents
    driver: bridge

volumes:
  sqlite-data:
    name: pops-sqlite-data
  metabase-data:
    name: pops-metabase-data
  paperless-data:
    name: pops-paperless-data
  paperless-media:
    name: pops-paperless-media
  paperless-consume:
    name: pops-paperless-consume
  paperless-redis:
    name: pops-paperless-redis

secrets:
  notion_api_token:
    file: ./secrets/notion_api_token
  up_bank_token:
    file: ./secrets/up_bank_token
  up_webhook_secret:
    file: ./secrets/up_webhook_secret
  claude_api_key:
    file: ./secrets/claude_api_key
  telegram_bot_token:
    file: ./secrets/telegram_bot_token
  finance_api_key:
    file: ./secrets/finance_api_key
  paperless_secret_key:
    file: ./secrets/paperless_secret_key
  paperless_admin_password:
    file: ./secrets/paperless_admin_password
